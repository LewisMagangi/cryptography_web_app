{% extends "blog/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
<div class="content-section">
    <form method="POST" enctype="multipart/form-data" id="analysisForm">
        {% csrf_token %}
        <fieldset class="form-group">
            <legend class="border-bottom mb-4">Analysis Parameters</legend>
            
            {{ form.crypto_type|as_crispy_field }}
            {{ form.algorithm|as_crispy_field }}
            {{ form.analysis_type|as_crispy_field }}
            
            <!-- File Selection - Always visible and required -->
            <div class="form-group mt-3" id="file-section">
                <label for="analysis_file">Select File for Analysis</label>
                <input type="file" 
                       class="form-control-file" 
                       id="analysis_file" 
                       name="analysis_file"
                       required>
                <div id="fileDetails" class="mt-2" style="display: none;">
                    <p>Selected file: <span id="fileName"></span></p>
                    <p>Size: <span id="fileSize"></span></p>
                </div>
            </div>
        </fieldset>
        <div class="form-group">
            <button class="btn btn-outline-info" type="submit">Generate Analysis</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cryptoType = document.getElementById('id_crypto_type');
        const algorithm = document.getElementById('id_algorithm');
        const analysisType = document.getElementById('id_analysis_type');

        function updateAlgorithmChoices() {
            const asymAlgos = [
                ['rsa', 'RSA'],
                ['dsa', 'DSA'],
                ['ecc', 'ECC'],
                ['dh', 'DH']
            ];
            const symAlgos = [
                ['aes', 'AES'],
                ['des', 'DES'],
                ['3des', '3DES'],
                ['blowfish', 'Blowfish'],
                ['rc2', 'RC2'],
                ['rc4', 'RC4']
            ];
            const hashAlgos = [
                ['sha-1', 'SHA-1'],
                ['sha-224', 'SHA-224'],
                ['sha-256', 'SHA-256'],
                ['sha-384', 'SHA-384'],
                ['sha-512', 'SHA-512'],
                ['md5', 'MD5'],
                ['hmac', 'HMAC']
            ];

            // Clear existing options
            algorithm.innerHTML = '';
            
            // Add new options based on crypto type
            let choices;
            if (cryptoType.value === 'asymmetric') {
                choices = asymAlgos;
            } else if (cryptoType.value === 'symmetric') {
                choices = symAlgos;
            } else {
                choices = hashAlgos;
            }

            choices.forEach(([value, label]) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                algorithm.appendChild(option);
            });
        }

        function updateAnalysisTypeVisibility() {
            // Hide analysis type selection for hash algorithms
            const isHash = cryptoType.value === 'hash';
            analysisType.closest('.form-group').style.display = isHash ? 'none' : 'block';
            
            if (isHash) {
                analysisType.value = 'filesize';  // Force filesize for hash
            }
        }

        // Event listeners
        cryptoType.addEventListener('change', updateAlgorithmChoices);
        cryptoType.addEventListener('change', updateAnalysisTypeVisibility);

        // Initial setup
        updateAlgorithmChoices();
        updateAnalysisTypeVisibility();

        // Enhanced file input handling
        const fileInput = document.getElementById('analysis_file');
        const fileDetails = document.getElementById('fileDetails');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                fileName.textContent = file.name;
                fileSize.textContent = (file.size / 1024).toFixed(2) + ' KB';
                fileDetails.style.display = 'block';
            }
        });
    });
</script>

<style>
    .custom-file-label {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    #file-section {
        border: 1px solid #e3e3e3;
        padding: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
    }
</style>
{% endblock content %}